<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
        <title>Find</title>
        <link href="http://code.google.com/apis/maps/documentation/javascript/examples/default.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/tags/markerwithlabel/1.0.1/src/markerwithlabel.js"></script>

        <script type="text/javascript">
var map; 

if (!localStorage.name) {
  localStorage.name = prompt("who are you?");
}

var name = localStorage.name;


//var name = "elliot";
var myLatLng;


function init() {
    myLatLng = new google.maps.LatLng(51.49, -0.12);
    var myOptions = {
      zoom: 10,
      center: myLatLng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);


  loadPositions();
}


function loadPositions() {
  if (navigator.geolocation) {

    navigator.geolocation.getCurrentPosition(
      function (position) {
        myLatlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

        $.ajax({
          url: "http://furnace.bip.coad.me/update",
          dataType: 'json',
          data: {
	          person: name, 
	          coords: [position.coords.latitude, position.coords.longitude], 
	          accuracy: position.coords.accuracy
	      },
          success: function(response) {
            var person;
            for (var key in response.bips ) {
              person = response.bips[key];

              var personLatlng = new google.maps.LatLng(person.Lat, person.Lon);
           
                
              var marker = new MarkerWithLabel({
                  position: personLatlng, 
                  map: map, 
                  animation: google.maps.Animation.DROP,
                  labelContent: person.Person + "(" + person.TimeSince + ")",
                  labelAnchor: new google.maps.Point(22, 0),
                  labelClass: "labels", // the CSS class for the label
                  labelStyle: {opacity: 1}
              });

              var infowindow = new google.maps.InfoWindow({
                  content: "<p>" + person.Person + "</p>",
                  maxWidth: 50
              });
              //infowindow.open(map,marker);

              /*
              google.maps.event.addListener(marker, 'click', function() {
              });
              */
            }
          },
          error: function () {
            alert("Unable to receive from server");
            //TODO: 
          }
        });
      }, 
      onGpsError
    );
  }

}

function onGpsError(error) {
  switch(error.code) 
  {
    case error.TIMEOUT:
      alert ('Timeout');
      break;
    case error.POSITION_UNAVAILABLE:
      alert ('Position unavailable');
      break;
    case error.PERMISSION_DENIED:
      alert ('Permission denied');
      break;
    case error.UNKNOWN_ERROR:
      alert ('Unknown error');
      break;
  }
}

        </script>
    </head>
    <body onload="init()">
        <div id="map_canvas"></div>
    </body>
</html>